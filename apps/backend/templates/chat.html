{% extends "base.html" %}
{% block content %}
<div id="chat" style="display:flex;flex-direction:column;height:90vh;">
  <div id="messages" style="flex:1;overflow-y:auto;margin-bottom:1rem;"></div>
  <form id="composer" style="display:flex;gap:0.5rem;">
    <input id="content" type="text" style="flex:1;" autocomplete="off" />
    <button type="submit">Send</button>
  </form>
</div>
<script>
const messages = document.getElementById('messages');
function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = role;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

async function sendMsg(event) {
  event.preventDefault();
  const input = document.getElementById('content');
  const text = input.value.trim();
  if (!text) return;
  addMsg('user', text);
  input.value = '';

  const bubble = addMsg('assistant', '');
  let acc = '';
  const src = new EventSource(`/api/conversations/1/message_stream?content=${encodeURIComponent(text)}`);
  src.onmessage = (e) => {
    if (e.data === '[DONE]') {
      src.close();
    } else {
      acc += e.data;
      bubble.textContent = acc;
    }
  };
  src.onerror = (e) => {
    console.error('SSE error:', e);
    src.close();
  };
}

document.getElementById('composer').addEventListener('submit', sendMsg);
document.getElementById('content').focus();
</script>
{% endblock %}
